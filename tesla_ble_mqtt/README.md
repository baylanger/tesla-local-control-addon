# Home Assistant Add-on: Tesla Local Commands

Send commands via MQTT to a Tesla car using Bluetooth Low Energy (BLE)


This Addon is a package of iainbullock's https://github.com/iainbullock/tesla_ble_mqtt_docker
It runs the official Tesla Vehicle SDK commands via BLE to activate various entities in your Tesla.
This is to bypass the current Fleet API rate limitation as it does not rely on the API.

This package contains:
- All the code generated by iainbullock repackaged as a HA addon
- A `standalone` folder which contains a single script to run the BLE service on a separate machine


# Prerequisites

You must already have a working MQTT broker. If you want the entities to be auto-discovered by Home Assistant (HA), then the HA MQTT Integration must already be set up and working. See: https://www.home-assistant.io/integrations/mqtt/
The advantage of the MQTT setup is that it can run on a device separate to your HA server, e.g. Raspberry Pi located close to where you park your car 


# Installation and setup

If you have already created a key pair that you want to reuse, place the private key in `/share/tesla_ble_mqtt`

## 1.1 HA Add-on: install below and configure

[![Open your Home Assistant instance and show the add add-on repository dialog with a specific repository URL pre-filled.](https://my.home-assistant.io/badges/supervisor_add_addon_repository.svg)](https://my.home-assistant.io/redirect/supervisor_add_addon_repository/?repository_url=https://github.com/raphmur/tesla-local-control-addon)


You will need to provide:
- TESLA_VIN (car VIN)
- BLE_MAC: Used for proximity discovery. Tesla's BLE MAC starts with "S" and ends with "C". To find the address, use "BLE scanner" on Android or "nRF Connect" on iOS.
- MQTT_IP: ip of your MQTT server
- MQTT_PORT
- MQTT_USER
- MQTT_PWD
- SEND_CMD_RETRY_DELAY: delay between retries in case BLE fails. Use 5 by default


## 1.2 For the standalone version

It has been tested on RPi 3B so far. Here are the assumptions and way forward:
- You already have Docker working on the host device, and you are familiar with basic Docker concepts and actions
- Clone the self packaged shell script: `wget https://github.com/raphmur/tesla-local-control-addon/blob/main/standalone/start_tesla_ble_mqtt.sh`
- Edit the script to input your own settings: TESLA_VIN, MQTT_IP (ip of your MQTT server), MQTT_PORT, MQTT_USER, MQTT_PWD, SEND_CMD_RETRY_DELAY (delay between retries in case BLE fails), _optional_ _BLE_MAC_ (to be used for proximity discovery)
- run the script: `./start_tesla_ble_mqtt.sh`, it will download the rest of the elements, build and deploy the container

## 2 Pairing with your car

- Navigate to the Tesla_BLE_MQTT Device info.
  - In HA : Settings -> Devices & Services -> Devices (tab) -> Tesla_BLE_MQTT
- Press : Generate Keys (required once)
- Press : Deploy Key (car may need to be awake - TBC)
  - If the command succeed to initiate the pairing with the car, the following will show in the add-on logs:
    `Sent add-key request to _YOUR_CAR_VIN. Confirm by tapping NFC card on center console.`
  - Tap your NFC card on the center console
  - On the car's screen `Phone Key pairing request`, confirm your accept the pairing

  - If the command failed, the following error will show up:
    `Error: failed to find BLE beacon for _YOUR_CAR_VIN_. (S________________C): can’t scan: context deadline exceeded`
  - You car might just be too far from your Bluetooth adapter.

- Credits : Shankar Kumarasamy's [Blog](https://shankarkumarasamy.blog/2024/01/28/tesla-developer-api-guide-ble-key-pair-auth-and-vehicle-commands-part-3/)

## 3 THEN

- A new device called Tesla_BLE_MQTT should have automatically appeared. Click it to view the the associated entities. You should find a list of Button entities and a Number entity
- If this is the first time you have run the container, press the 'Generate Keys' button in HA (Settings -> Devices & Services -> Devices (tab) -> Tesla_BLE_MQTT). This will generate the public and private keys as per Shanker's blog
- **Wake up your car using the Tesla App**. Then press the 'Deploy Key' button. This will deploy the public key to the car. You will then need to access your car and use a Key Card to accept the public key into the car (see the blog for screenshots)
  - If the command succeed to initiate the pairing with the car, the following will show in the add-on logs: `Sent add-key request to [YOUR_CAR_VIN]. Confirm by tapping NFC card on center console.` Go in your car and tap your NFC card on the center console and on the car's screen `Phone Key pairing request`, confirm your accept the pairing
  - If the command failed, the following error will show up: `Error: failed to find BLE beacon for [YOUR_CAR_VIN]. (xxx): can’t scan: context deadline exceeded`. You car might just be too far from your Bluetooth adapter. The command will be tried in case bluetooth is weak or unavailable...
- Then you are ready. Press the other button entities to send various commands... You can use the relevant service calls in HA automations if you wish

## Credits

Full package originally built by https://github.com/iainbullock following exchanges on the Tesla Custom Integration Issues https://github.com/alandtse/tesla/issues/961#issuecomment-2150897886 

The technical method was derived from Shankar Kumarasamy's blog https://shankarkumarasamy.blog/2024/01/28/tesla-developer-api-guide-ble-key-pair-auth-and-vehicle-commands-part-3
